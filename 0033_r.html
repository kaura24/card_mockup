<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KB국민카드 | 추가 서류 제출 (0033)</title>

  <style>
    :root{
      --text:#111;
      --muted:#666;
      --line:#d9d9d9;
      --panel:#f4f6f9;
      --req:#d64545;
      --kb-yellow:#ffcc00;
      --kb-yellow-dark:#f2b800;
      --white:#fff;

      --modal-bg:rgba(0,0,0,.6);
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo",Arial,sans-serif;
      color:var(--text);
      background:var(--white);
      line-height:1.5;
    }

    /* ===== Page ===== */
    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding:34px 24px 90px;
    }

    /* Header */
    .header-group{margin-bottom:18px;}
    .title{
      margin:0;
      font-size:30px;
      font-weight:900;
      letter-spacing:-.7px;
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .screen-id{
      font-size:.78em;
      font-weight:900;
      color:#666;
      letter-spacing:-.2px;
      white-space:nowrap;
    }
    .subnote{
      margin:8px 0 0;
      color:#555;
      font-size:14px;
      font-weight:650;
    }

    /* Form layout */
    .form-container{border-top:2px solid #333;margin-top:18px;}
    .required-info{
      text-align:right;
      font-size:13px;
      color:var(--muted);
      margin:10px 0 8px;
    }
    .required-info .star{color:var(--req);margin-right:4px;}

    .form-row{
      display:grid;
      grid-template-columns:280px 1fr;
      border-bottom:1px solid var(--line);
      align-items:stretch;
    }
    .form-label{
      background:#fafafa;
      padding:18px 24px;
      display:flex;
      align-items:center;
      font-size:16px;
      font-weight:800;
      color:#333;
    }
    .form-label .star{color:var(--req);margin-left:4px;}
    .form-content{
      padding:16px 24px 18px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Document list */
    .doc-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:6px 0 2px;
    }
    .doc-row{
      display:grid;
      grid-template-columns:260px 1fr 120px;
      gap:12px;
      align-items:center;
    }
    .doc-name{
      font-size:14px;
      font-weight:750;
      color:#444;
      display:flex;
      align-items:center;
      gap:8px;
      line-height:1.35;
      flex-wrap:wrap;
    }
    .doc-name .req-badge{
      color:var(--req);
      font-weight:900;
      margin-left:4px;
    }
    .info-icon{
      width:18px;height:18px;
      border-radius:9px;
      border:1px solid #cfcfcf;
      color:#777;
      display:inline-grid;
      place-items:center;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }

    .file-display{
      width:100%;
      height:46px;
      border:1px solid var(--line);
      border-radius:8px;
      padding:0 14px;
      font-size:14px;
      color:#333;
      background:#fff;
      outline:none;
    }
    .file-display::placeholder{color:#999;font-weight:650;}
    .file-display.is-invalid{
      border-color:var(--req);
      background:#fff9f9;
    }

    .btn-browse{
      height:46px;
      border:1px solid var(--line);
      border-radius:8px;
      background:#efefef;
      color:#333;
      font-weight:850;
      cursor:pointer;
      transition:.15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-browse:hover{background:#e7e7e7;}
    .btn-browse:active{transform:scale(.98);}

    .help-line{
      margin:4px 0 0;
      font-size:13px;
      color:#777;
    }

    /* bottom buttons */
    .btn-area{
      margin-top:42px;
      display:flex;
      justify-content:center;
      gap:14px;
    }
    .btn-secondary{
      width:180px;height:56px;
      border-radius:10px;
      border:1px solid #cfcfcf;
      background:#fff;
      color:#333;
      font-size:17px;
      font-weight:900;
      cursor:pointer;
      transition:.15s ease;
    }
    .btn-secondary:hover{background:#fafafa;}
    .btn-secondary:active{transform:scale(.98);}

    .btn-primary{
      width:260px;height:56px;
      border:none;
      border-radius:10px;
      background:var(--kb-yellow);
      color:#222;
      font-size:18px;
      font-weight:950;
      cursor:pointer;
      transition:.15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn-primary:hover{background:var(--kb-yellow-dark);}
    .btn-primary:active{transform:scale(.98);}
    .btn-primary:disabled{
      background:#eee;
      color:#aaa;
      cursor:not-allowed;
      transform:none;
    }

    .spinner{
      width:18px;height:18px;
      border:3px solid rgba(0,0,0,0.12);
      border-top-color:#333;
      border-radius:50%;
      animation:spin .8s linear infinite;
      display:none;
    }
    .btn-primary.is-loading .spinner{display:block;}
    .btn-primary.is-loading .btn-text{display:none;}
    @keyframes spin{to{transform:rotate(360deg);}}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:40px;
      transform:translateX(-50%) translateY(20px);
      background:rgba(33,33,33,.92);
      color:#fff;
      padding:12px 22px;
      border-radius:30px;
      font-size:14px;
      font-weight:650;
      opacity:0;
      pointer-events:none;
      transition:all .28s cubic-bezier(.175,.885,.32,1.275);
      z-index:3000;
      box-shadow:0 8px 24px rgba(0,0,0,.2);
      max-width:calc(100vw - 40px);
      text-align:center;
      line-height:1.35;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

    /* ===== 요구사항 버튼(물음표 아이콘 / 컬러) ===== */
    .req-trigger{
      position:fixed;
      right:24px;
      bottom:24px;
      width:56px;height:56px;
      border-radius:50%;
      background:#222;
      color:var(--kb-yellow);
      border:none;
      font-size:26px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.3);
      z-index:2900;
      transition:transform .2s;
    }
    .req-trigger:hover{transform:rotate(15deg) scale(1.08);}
    .req-trigger:active{transform:scale(.98);}

    /* ===== Spec modal ===== */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:var(--modal-bg);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:4000;
      backdrop-filter:blur(4px);
    }
    .modal-overlay.show{display:flex;}
    .modal-content{
      width:100%;
      max-width:900px;
      background:#fff;
      border-radius:16px;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 24px 48px rgba(0,0,0,.4);
    }
    .modal-header{
      padding:20px 24px;
      border-bottom:1px solid #eee;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      background:#fff;
    }
    .modal-header h2{margin:0;font-size:18px;font-weight:900;}
    .modal-close{
      background:#f5f5f5;
      border:none;
      padding:8px 16px;
      border-radius:6px;
      cursor:pointer;
      font-weight:850;
    }
    .modal-body{padding:24px;}
    .spec-table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:14px;}
    .spec-table th,.spec-table td{border:1px solid #eee;padding:12px;text-align:left;vertical-align:top;}
    .spec-table th{background:#f9f9f9;width:160px;font-weight:850;}
    .spec-section{margin-top:24px;}
    .spec-section h3{font-size:15px;margin-bottom:12px;border-left:4px solid var(--kb-yellow);padding-left:10px;font-weight:900;}
    .spec-section ul{margin:0;padding-left:20px;font-size:14px;line-height:1.6;}
    .json-code{
      background:#1e1e1e;color:#d4d4d4;
      padding:16px;border-radius:8px;
      font-family:var(--mono);
      font-size:12px;overflow-x:auto;margin-top:12px;
    }

    /* Responsive */
    @media (max-width: 920px){
      .doc-row{grid-template-columns:1fr; gap:8px;}
      .btn-browse{width:160px;}
    }
    @media (max-width: 860px){
      .form-row{grid-template-columns:1fr;}
      .form-label{padding:12px 20px;border-bottom:1px solid #eee;}
      .form-content{padding:16px 20px;}
      .btn-area{flex-direction:column;}
      .btn-secondary,.btn-primary{width:100%;}
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css"/>
  <link rel="stylesheet" href="css/kb-theme.css"/>
  <link rel="stylesheet" href="css/common.css" />
</head>

<body>

  <div class="wrap">
    <div class="header-group">
      <!-- ✅ 제목 옆에 화면번호 실제 렌더 + 탭 타이틀도 JS에서 SSOT로 동기화 -->
      <h1 id="page-title" class="title">
        <span id="title-text">추가 서류 제출</span>
        <span id="title-id" class="screen-id">(0033)</span>
      </h1>
      <p class="subnote">서류제출 첨부 항목을 업로드해 주세요.</p>
    </div>

    <div class="required-info">
      <span class="star" aria-hidden="true">*</span>필수입력항목
    </div>

    <div class="form-container">
      <section class="form-row">
        <div class="form-label">
          서류제출 첨부 <span class="star" aria-hidden="true">*</span>
        </div>

        <div class="form-content">
          <div id="doc-list" class="doc-list" aria-label="추가 서류 제출 목록">
            <!-- JS 렌더 -->
          </div>
          <div class="help-line">업로드 가능 형식: JPG, JPEG, PNG, PDF</div>
          <div class="help-line">※ 필수 항목(4개) 미제출 시 다음 단계로 진행할 수 없습니다.</div>
        </div>
      </section>
    </div>

    <div class="btn-area">
      <button type="button" id="btn-edit" class="btn-secondary">수정하기</button>
      <button type="button" id="btn-next" class="btn-primary" disabled>
        <span class="spinner" aria-hidden="true"></span>
        <span class="btn-text">다음</span>
      </button>
    </div>
  </div>

  

  <!-- ✅ 요구사항 보기 버튼(물음표 아이콘 / 컬러) -->
  <button type="button" id="btn-spec" class="req-trigger" title="기능요구서 확인" aria-label="기능요구서 및 주석 보기">?</button>

  <!-- 요구사항 모달 -->
  <div id="modal-spec" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">기능요구서 및 주석</h2>
        <button type="button" id="btn-modal-close" class="modal-close">닫기</button>
      </div>
      <div id="modal-body" class="modal-body"></div>
    </div>
  </div>

<script>
    const SCREEN_ID = "0033";
/**
 * KB국민카드 기업카드 신청 프로세스 - Step 0033
 * 추가 서류 제출(파일 업로드) 화면
 *
 * 핵심 리팩토링 포인트
 * 1) 타이틀/화면번호/탭타이틀: SSOT(META) 기반으로 1회 정의 후 동기화
 * 2) 요구사항/주석: ? FAB 버튼으로 모달 표시(요건정의서 + JSON)
 * 3) 필수서류 검증: 4개 필수 항목 업로드 + 확장자 유효 시에만 Next 활성
 */
(function(){
  // =========================
  // 0) SSOT: 화면 메타
  // =========================
  const META = {
    id: "0033",
    title: "추가 서류 제출",
    name: "추가서류제출",
    editTarget: "0020",  // 수정하기: "명세서 받으실 곳(ID:0020)"로 이동(요건에 맞춤)
    nextTarget: "0034"   // 다음 화면(목업): 신청완료 등 실제 플로우에 맞게 교체
  };

  // 탭/제목 동기화
  document.title = `KB국민카드 | ${META.title} (${META.id})`;
  document.getElementById("title-text").textContent = META.title;
  document.getElementById("title-id").textContent = `(${META.id})`;

  // =========================
  // 1) 정책/상수
  // =========================
  const ALLOWED_EXT = new Set(["jpg","jpeg","png","pdf"]);
  const ACCEPT = "image/jpeg,image/png,application/pdf";

  // 서류 목록(요건정의서 기반)
  // - 필수: 사업자등록증, 법인등기부, 주주명부 및 정관, 신청인 신분증
  // - 선택: 표준재무제표증명, 부가세과세표준증명원, 기타, 기타
  const DOCS = [
    { key:"biz_cert", name:"사업자등록증 사본 또는 사업자등록증명원", required:true },
    { key:"corp_reg", name:"법인등기사항전부증명서", required:true },
    { key:"holders",  name:"주주명부 및 정관", required:true, info:"정관 포함 제출(정책 기준에 따라 변경 가능)" },
    { key:"id_card",  name:"신청인 신분증", required:true },
    { key:"fs_std",   name:"표준재무제표증명", required:false },
    { key:"vat_std",  name:"부가세과세표준증명원", required:false },
    { key:"etc_1",    name:"기타", required:false },
    { key:"etc_2",    name:"기타", required:false }
  ];

  // =========================
  // 2) DOM
  // =========================
  const toast = document.getElementById("toast");
  const docListEl = document.getElementById("doc-list");
  const btnEdit = document.getElementById("btn-edit");
  const btnNext = document.getElementById("btn-next");

  const specBtn = document.getElementById("btn-spec");
  const modal = document.getElementById("modal-spec");
  const modalClose = document.getElementById("btn-modal-close");

  // =========================
  // 3) State
  // =========================
  // state[key] = { file: File|null, valid: boolean }
  const state = Object.fromEntries(DOCS.map(d => [d.key, { file:null, valid:false } ]));

  // =========================
  // 4) Utils
  // =========================
  const showToast = (message) => {
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
  };

  const setLoading = (isLoading) => {
    btnNext.disabled = isLoading || !canProceed();
    btnNext.classList.toggle("is-loading", isLoading);
  };

  const getExt = (filename) => {
    const idx = filename.lastIndexOf(".");
    if (idx === -1) return "";
    return filename.slice(idx + 1).toLowerCase();
  };

  const validateFile = (file) => {
    if (!file) return { ok:false, msg:"파일이 선택되지 않았습니다." };
    const ext = getExt(file.name);
    if (!ALLOWED_EXT.has(ext)) {
      return { ok:false, msg:"JPG, JPEG, PNG, PDF만 업로드 가능합니다." };
    }
    return { ok:true, msg:"" };
  };

  const canProceed = () => {
    for (const d of DOCS) {
      if (!d.required) continue;
      if (!state[d.key].file || !state[d.key].valid) return false;
    }
    return true;
  };

  const updateNextState = () => {
    if (btnNext.classList.contains("is-loading")) return;
    btnNext.disabled = !canProceed();
  };

  const markFirstMissing = () => {
    const first = DOCS.find(d => d.required && (!state[d.key].file || !state[d.key].valid));
    if (!first) return;

    const row = docListEl.querySelector(`[data-key="${first.key}"]`);
    const display = row ? row.querySelector(".file-display") : null;
    if (display) display.classList.add("is-invalid");
  };

  // =========================
  // 5) Render (Doc rows)
  // =========================
  const render = () => {
    docListEl.innerHTML = "";

    DOCS.forEach((d) => {
      const row = document.createElement("div");
      row.className = "doc-row";
      row.dataset.key = d.key;

      const name = document.createElement("div");
      name.className = "doc-name";
      name.innerHTML = `
        <span>${d.name}${d.required ? ' <span class="req-badge">(필수)</span>' : ''}</span>
      `;

      if (d.info) {
        const info = document.createElement("span");
        info.className = "info-icon";
        info.textContent = "?";
        info.title = d.info;
        info.setAttribute("role","button");
        info.setAttribute("tabindex","0");
        info.addEventListener("click", () => showToast(d.info));
        info.addEventListener("keydown", (e) => { if (e.key === "Enter") showToast(d.info); });
        name.appendChild(info);
      }

      const display = document.createElement("input");
      display.type = "text";
      display.className = "file-display";
      display.placeholder = "JPG, JPEG, PNG, PDF만 업로드 가능";
      display.readOnly = true;
      display.setAttribute("aria-label", `${d.name} 파일명`);

      const browse = document.createElement("button");
      browse.type = "button";
      browse.className = "btn-browse";
      browse.textContent = "찾아보기";
      browse.setAttribute("aria-label", `${d.name} 찾아보기`);

      const file = document.createElement("input");
      file.type = "file";
      file.accept = ACCEPT;
      file.style.display = "none";

      // open file dialog
      browse.addEventListener("click", () => file.click());

      // change file
      file.addEventListener("change", () => {
        const f = (file.files && file.files[0]) ? file.files[0] : null;
        const { ok, msg } = validateFile(f);

        if (!f) {
          state[d.key] = { file:null, valid:false };
          display.value = "";
          display.classList.remove("is-invalid");
          updateNextState();
          return;
        }

        display.value = f.name;

        if (!ok) {
          state[d.key] = { file:f, valid:false };
          display.classList.add("is-invalid");
          showToast(msg);
          updateNextState();
          return;
        }

        state[d.key] = { file:f, valid:true };
        display.classList.remove("is-invalid");
        updateNextState();
      });

      row.appendChild(name);
      row.appendChild(display);
      row.appendChild(browse);
      row.appendChild(file); // hidden input

      docListEl.appendChild(row);
    });

    updateNextState();
  };

  // =========================
  // 6) Navigation (mock)
  // =========================
  const goTo = (id) => { location.hash = `#/${id}`; };

  btnEdit.addEventListener("click", () => {
    // 요건: "수정하기 버튼을 누르면 명세서 받으실 곳(ID:0020)으로 간다"
    showToast("수정하기: 명세서 받으실 곳으로 이동합니다.");
    if (window.ScenarioNav) {
ScenarioNav.goNext();
      } else {
        setTimeout(() => goTo(META.editTarget), 250);
      }
    }
  });

  btnNext.addEventListener("click", async () => {
    if (btnNext.classList.contains("is-loading")) return;

    if (!canProceed()) {
      showToast("필수 서류를 모두 업로드해 주세요.");
      markFirstMissing();
      return;
    }

    setLoading(true);
    showToast("서류 확인 중입니다...");

    try {
      // 실제 서비스: FormData 구성 → 서버 업로드 → 업로드키/증빙ID 반환 후 다음 단계
      // 목업: 딜레이 후 이동
      await new Promise(res => setTimeout(res, 700));
      showToast("업로드 완료. 다음 단계로 이동합니다.");
      if (window.ScenarioNav) {
ScenarioNav.goNext();
      } else {
            setTimeout(() => goTo(META.nextTarget), 600);
          }
        }
      }
    } finally {
      setLoading(false);
    }
  });

  // =========================
  // 7) Spec modal (요건정의서/주석)
  // =========================
  const REQ_SPEC = {
    screen_id: META.id,
    screen_name: META.name,
    purpose: "추가 서류 제출(필수/선택 파일 업로드) 후 다음 단계 진행",
    business_rule_source: "화면기능목록 ID:0033 (추가서류제출)",
    rules: [
      "업로드 파일 형식은 PDF, 이미지(jpg, jpeg, png) 허용",
      "필수 항목: 사업자등록증, 법인등기부, 주주명부 및 정관, 신청인 신분증",
      "선택 항목: 표준재무제표증명, 부가세과세표준증명원, 기타(2개)",
      "필수 미제출 또는 확장자 오류 시 다음 진행 불가",
      "수정하기 버튼 클릭 시 '명세서 받으실 곳(ID:0020)'으로 이동"
    ],
    required_docs: DOCS.filter(d => d.required).map(d => d.name),
    optional_docs: DOCS.filter(d => !d.required).map(d => d.name),
    next: `${META.nextTarget}(목업) - 실제 플로우에 맞게 교체`,
    qa_points: [
      "각 행 '찾아보기' 버튼이 해당 file input을 정상 트리거하는지",
      "허용 확장자 외 업로드 시 invalid 표시 + 토스트 안내",
      "필수 미충족 시 Next 비활성 + Next 클릭 방어",
      "모바일 레이아웃(3열 → 1열) 전환 시 UI 깨짐 여부",
      "파일 재선택/취소 시 state/표시값/Next 활성화 일관성"
    ],
    data_spec: {
      accept: ACCEPT,
      allowed_ext: Array.from(ALLOWED_EXT),
      state_shape: "{ [key]: { file: File|null, valid: boolean } }"
    }
  };

  const renderSpec = () => {
    const body = document.getElementById("modal-body");
    const title = document.getElementById("modal-title");
    if (title) title.textContent = `기능요구서 및 주석 (${META.id})`;

    body.innerHTML = `
      <table class="spec-table">
        <tr><th>화면 ID</th><td>${REQ_SPEC.screen_id}</td></tr>
        <tr><th>화면명</th><td>${REQ_SPEC.screen_name}</td></tr>
        <tr><th>목적</th><td>${REQ_SPEC.purpose}</td></tr>
        <tr><th>근거</th><td>${REQ_SPEC.business_rule_source}</td></tr>
        <tr><th>다음 단계</th><td>${REQ_SPEC.next}</td></tr>
      </table>

      <div class="spec-section">
        <h3>규칙</h3>
        <ul>${REQ_SPEC.rules.map(x => `<li>${x}</li>`).join("")}</ul>
      </div>

      <div class="spec-section">
        <h3>필수 제출</h3>
        <ul>${REQ_SPEC.required_docs.map(x => `<li>${x}</li>`).join("")}</ul>
      </div>

      <div class="spec-section">
        <h3>선택 제출</h3>
        <ul>${REQ_SPEC.optional_docs.map(x => `<li>${x}</li>`).join("")}</ul>
      </div>

      <div class="spec-section">
        <h3>QA / 개발 체크리스트</h3>
        <ul>${REQ_SPEC.qa_points.map(x => `<li>${x}</li>`).join("")}</ul>
      </div>

      <div class="spec-section">
        <h3>데이터 스펙 (JSON)</h3>
        <div class="json-code">${JSON.stringify(REQ_SPEC, null, 2)}</div>
      </div>
    `;
  };

  const openModal = () => {
    renderSpec();
    modal.classList.add("show");
    modal.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
    modalClose.focus();
  };

  const closeModal = () => {
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
    specBtn.focus();
  };

  specBtn.addEventListener("click", openModal);
  modalClose.addEventListener("click", closeModal);
  modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

  // ESC: 스펙 모달 우선 닫기
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    if (modal.classList.contains("show")) closeModal();
  });

  // init
  render();
})();
</script>
<script src="js/common.js"></script>
<script src="js/session-db.js"></script>
<script src="js/scenario-nav.js"></script>
<script src="js/spec-viewer.js" data-screen-id="0033"></script>
</body>
</html>
