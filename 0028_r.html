<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KB국민카드 | 전자 서명 작성 (0028)</title>

  <style>
    :root {
      --kb-blue: #2c7be5;
      --kb-yellow: #ffcc00;
      --text-main: #333;
      --text-muted: #666;
      --line-light: #e0e0e0;
      --bg-light: #f9f9f9;
      --white: #fff;
      --shadow-pop: 0 10px 30px rgba(0,0,0,0.15);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      color: var(--text-main);
      background: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 40px 20px;
    }

    /* ===== Popup Container ===== */
    .cert-popup {
      width: 100%;
      max-width: 580px;
      background: var(--white);
      border-radius: 4px;
      box-shadow: var(--shadow-pop);
      border: 1px solid #ccc;
      overflow: hidden;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Header */
    .popup-header {
      padding: 12px 20px;
      border-bottom: 2px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .popup-header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
      color: #333;
    }
    .header-logo-small { height: 20px; opacity: 0.6; }

    /* KB Banner Section */
    .kb-banner {
      height: 80px;
      background: linear-gradient(90deg, #fff 0%, #fefdf0 100%);
      border-bottom: 1px solid var(--line-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      position: relative;
    }
    .kb-banner .logo-area img { height: 24px; }
    .kb-banner .illust-area { height: 100%; display: flex; align-items: flex-end; }
    .kb-banner .illust-area svg { height: 70px; width: auto; }

    .popup-content { padding: 20px; }

    /* Section Styles */
    .section-group { margin-bottom: 24px; }
    .section-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #111;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .install-hint { font-size: 11px; color: #888; font-weight: 400; }

    /* 1. Storage Selector */
    .storage-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .storage-btn {
      border: 1px solid var(--line-light);
      background: var(--white);
      padding: 12px 8px;
      border-radius: 2px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      transition: all 0.2s;
    }
    .storage-btn span { font-size: 12px; font-weight: 600; color: #444; }
    .storage-btn .icon-box { width: 32px; height: 32px; display: grid; place-items: center; }
    
    .storage-btn.active {
      border: 2px solid var(--kb-blue);
      background: #f3f8ff;
    }
    .storage-btn.active::before {
      content: '✓';
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 10px;
      color: var(--white);
      background: var(--kb-blue);
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 2. Certificate Table */
    .table-container {
      border: 1px solid var(--line-light);
      height: 140px;
      overflow-y: auto;
      margin-bottom: 8px;
    }
    .cert-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .cert-table th {
      background: #f2f2f2;
      border-bottom: 1px solid var(--line-light);
      padding: 8px;
      position: sticky;
      top: 0;
      text-align: left;
    }
    .cert-table td {
      padding: 8px;
      border-bottom: 1px dotted #eee;
    }
    .empty-msg {
      height: 100px;
      text-align: center;
      color: #999;
      vertical-align: middle;
      line-height: 1.5;
      font-size: 11px;
    }

    .table-actions {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
    }
    .btn-sm {
      padding: 4px 10px;
      font-size: 11px;
      border: 1px solid #ccc;
      background: #fff;
      color: #333;
      cursor: pointer;
      border-radius: 2px;
    }
    .btn-sm:disabled { color: #ccc; cursor: not-allowed; }

    /* 3. Password Section */
    .password-wrap {
      border: 1px solid #ccc;
      padding: 16px;
      background: #fff;
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .cert-pass-input {
      flex: 1;
      height: 36px;
      border: 1px solid var(--kb-blue);
      padding: 0 10px;
      font-size: 16px;
      outline: none;
    }
    .keyboard-icon {
      width: 36px;
      height: 36px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      display: grid;
      place-items: center;
      cursor: pointer;
    }
    .pass-hint {
      font-size: 12px;
      color: #777;
      text-align: center;
    }

    /* Footer Buttons */
    .popup-footer {
      display: flex;
      gap: 8px;
      justify-content: center;
      padding: 0 20px 24px;
    }
    .btn-main {
      width: 140px;
      height: 40px;
      font-size: 15px;
      font-weight: 700;
      border-radius: 2px;
      cursor: pointer;
      border: 1px solid #ccc;
    }
    .btn-confirm { background: var(--kb-blue); color: var(--white); border: none; }
    .btn-cancel { background: var(--white); color: #333; }
    .btn-confirm:disabled { background: #cbd5e0; cursor: not-allowed; }

    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 60px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 13px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 5000;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }

    /* Responsive */
    @media (max-width: 480px) {
      body { padding: 0; }
      .cert-popup { max-width: none; border: none; height: 100vh; border-radius: 0; }
      .storage-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css"/>
  <link rel="stylesheet" href="css/kb-theme.css"/>
  <link rel="stylesheet" href="css/common.css" />
</head>

<body>

  <article class="cert-popup" id="cert-module">
    <header class="popup-header">
      <h1>전자 서명 작성</h1>
      <svg class="header-logo-small" viewBox="0 0 100 20">
        <text x="0" y="15" fill="#333" font-weight="bold" font-size="12">KB 국민카드</text>
      </svg>
    </header>

    <!-- KB 일러스트 배너 -->
    <div class="kb-banner" aria-hidden="true">
      <div class="logo-area">
        <img src="https://img1.kbcard.com/img/common/logo_card.png" alt="KB국민카드" onerror="this.style.display='none'">
        <span style="font-weight: 900; font-size: 18px; color: #555; vertical-align: middle;">KB국민카드</span>
      </div>
      <div class="illust-area">
        <!-- 이미지 속 무지개와 캐릭터 느낌의 SVG -->
        <svg viewBox="0 0 160 80">
          <path d="M100 70 Q130 10 160 70" stroke="#ffcc00" stroke-width="4" fill="none" opacity="0.5"/>
          <circle cx="120" cy="40" r="10" fill="#ffcc00"/>
          <rect x="20" y="60" width="140" height="20" fill="#8bc34a" opacity="0.3"/>
        </svg>
      </div>
    </div>

    <main class="popup-content">
      <!-- 1. 저장 위치 선택 -->
      <section class="section-group">
        <h2 class="section-title">인증서 저장 위치를 선택해 주세요</h2>
        <div class="storage-grid" id="storage-list">
          <button type="button" class="storage-btn active" data-id="browser">
            <div class="icon-box">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20z"/><path d="M2 12h20"/>
              </svg>
            </div>
            <span>브라우저</span>
          </button>
          <button type="button" class="storage-btn" data-id="find">
            <div class="icon-box">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
            </div>
            <span>인증서 찾기</span>
          </button>
          <button type="button" class="storage-btn" data-id="hdd">
            <div class="icon-box">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="2" width="20" height="20" rx="2"/><path d="M12 18h.01"/><path d="M7 14h10"/>
              </svg>
            </div>
            <span>로컬디스크</span>
          </button>
          <button type="button" class="storage-btn" data-id="extra">
            <div class="icon-box">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v10m0 0l-3-3m3 3l3-3"/><rect x="2" y="12" width="20" height="10" rx="2"/>
              </svg>
            </div>
            <span>확장매체</span>
          </button>
        </div>
        <p class="install-hint" style="text-align: right; margin-top: 4px;">*프로그램(Delfino G3)을 설치해야합니다.</p>
      </section>

      <!-- 2. 인증서 선택 -->
      <section class="section-group">
        <h2 class="section-title">사용할 인증서를 선택해 주세요</h2>
        <div class="table-container">
          <table class="cert-table">
            <thead>
              <tr>
                <th style="width: 20%;">구분</th>
                <th style="width: 35%;">사용자</th>
                <th style="width: 20%;">만료일</th>
                <th style="width: 25%;">발급자</th>
              </tr>
            </thead>
            <tbody id="cert-body">
              <tr>
                <td colspan="4" class="empty-msg">
                  <div style="margin-bottom: 5px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2">
                      <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18"/><path d="M7 15h.01"/><path d="M11 15h2"/>
                    </svg>
                  </div>
                  인증서 파일(*.pfx, *.p12 또는 signCert.der/signPri.key 묶음)을 끌어<br>놓으면 인증서 복사 및 서명이 가능합니다.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="table-actions">
          <button type="button" class="btn-sm" id="btn-view" disabled>인증서 보기</button>
          <button type="button" class="btn-sm" id="btn-delete" disabled>인증서 삭제</button>
        </div>
      </section>

      <!-- 3. 암호 입력 -->
      <section class="section-group" style="margin-bottom: 0;">
        <h2 class="section-title">인증서 암호를 입력해 주세요</h2>
        <div class="password-wrap">
          <div class="input-row">
            <input type="password" id="cert-pw" class="cert-pass-input" placeholder="" maxlength="30">
            <button type="button" class="keyboard-icon" title="가상키보드">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
                <rect x="2" y="5" width="20" height="14" rx="2"/><path d="M6 10h.01"/><path d="M10 10h.01"/><path d="M14 10h.01"/><path d="M18 10h.01"/><path d="M6 14h.01"/><path d="M10 14h8"/>
              </svg>
            </button>
          </div>
          <p class="pass-hint">안전한 금융거래를 위해 6개월마다 인증서 암호를 변경하시기 바랍니다.</p>
        </div>
      </section>
    </main>

    <footer class="popup-footer">
      <button type="button" class="btn-main btn-confirm" id="btn-submit" disabled>확인</button>
      <button type="button" class="btn-main btn-cancel" id="btn-cancel">취소</button>
    </footer>
  </article>

  <!-- Spec FAB & Modal -->
  <button type="button" id="btn-spec" style="position:fixed; bottom:20px; right:20px; width:44px; height:44px; border-radius:50%; background:#222; color:var(--kb-yellow); border:none; cursor:pointer; font-weight:bold; z-index:9999;">?</button>
  
  <div id="modal-spec" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; place-items:center; z-index:10000; padding:20px;">
    <div style="background:#fff; width:100%; max-width:600px; padding:24px; border-radius:8px; max-height:80vh; overflow-y:auto;">
      <h2 style="margin-top:0;">기능 명세서 (0028)</h2>
      <table style="width:100%; border-collapse:collapse; font-size:13px;">
        <tr style="border-bottom:1px solid #eee;"><th style="padding:10px; text-align:left; background:#f9f9f9; width:100px;">화면ID</th><td style="padding:10px;">0028</td></tr>
        <tr style="border-bottom:1px solid #eee;"><th style="padding:10px; text-align:left; background:#f9f9f9;">화면명</th><td style="padding:10px;">공동인증서 인증 (전자 서명 작성)</td></tr>
        <tr style="border-bottom:1px solid #eee;"><th style="padding:10px; text-align:left; background:#f9f9f9;">디자인 기준</th><td style="padding:10px;">Delfino G3 전자서명 모듈 표준 UI 적용</td></tr>
      </table>
      <h3 style="font-size:15px; margin-top:20px;">구현 노트</h3>
      <ul style="font-size:13px; color:#555; line-height:1.6;">
        <li>이미지의 상단 배너 및 섹션 순서(저장소-목록-암호)를 1:1로 매칭</li>
        <li>저장소 버튼 클릭 시 시각적 피드백(체크마크/테두리) 강화</li>
        <li>브라우저 저장소 선택 시 샘플 데이터를 자동 로딩하여 시연 가능하게 구성</li>
        <li>암호 입력 6자 이상 시 '확인' 버튼 활성화 로직 적용</li>
      </ul>
      <button type="button" id="btn-spec-close" style="width:100%; padding:10px; margin-top:20px; background:#eee; border:none; border-radius:4px; cursor:pointer;">닫기</button>
    </div>
  </div>

  

<script>
    const SCREEN_ID = "0028";
/**
 * KB국민카드 기업카드 신청 - 공동인증서 인증(0028) 리팩토링
 */
(function(){
  const META = {
    id: "0028",
    name: "전자 서명 작성",
    nextTarget: "0029"
  };

  const state = {
    selectedStorage: 'browser',
    certificates: [],
    selectedIndex: -1
  };

  // DOM
  const storageBtns = document.querySelectorAll('.storage-btn');
  const certBody = document.getElementById('cert-body');
  const passInput = document.getElementById('cert-pw');
  const submitBtn = document.getElementById('btn-submit');
  const cancelBtn = document.getElementById('btn-cancel');
  const toast = document.getElementById('toast');
  const btnView = document.getElementById('btn-view');
  const btnDelete = document.getElementById('btn-delete');

  const showToast = (msg) => {
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
  };

  // 1. 저장소 스캔 시뮬레이션
  const scanCertificates = (storageId) => {
    certBody.innerHTML = '<tr><td colspan="4" class="empty-msg">인증서를 조회하는 중입니다...</td></tr>';
    
    setTimeout(() => {
      if (storageId === 'browser') {
        state.certificates = [
          { type: '법인용', user: '주식회사국민(12381554...)', expiry: '2026.11.30', issuer: '금융결제원' },
          { type: '범용법인', user: '국민테스트(10182441...)', expiry: '2025.05.20', issuer: '한국전보인증' }
        ];
      } else {
        state.certificates = [];
      }
      renderCertTable();
    }, 500);
  };

  // 2. 인증서 테이블 렌더링
  const renderCertTable = () => {
    if (state.certificates.length === 0) {
      certBody.innerHTML = `
        <tr>
          <td colspan="4" class="empty-msg">
            <div style="margin-bottom: 5px;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2">
                <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18"/><path d="M7 15h.01"/><path d="M11 15h2"/>
              </svg>
            </div>
            인증서 파일(*.pfx, *.p12 또는 signCert.der/signPri.key 묶음)을 끌어<br>놓으면 인증서 복사 및 서명이 가능합니다.
          </td>
        </tr>`;
      btnView.disabled = true;
      btnDelete.disabled = true;
      return;
    }

    certBody.innerHTML = state.certificates.map((c, idx) => `
      <tr style="cursor:pointer;" class="cert-row" data-index="${idx}">
        <td>${c.type}</td>
        <td>${c.user}</td>
        <td>${c.expiry}</td>
        <td>${c.issuer}</td>
      </tr>
    `).join('');

    document.querySelectorAll('.cert-row').forEach(row => {
      row.addEventListener('click', function() {
        document.querySelectorAll('.cert-row').forEach(r => r.style.background = 'none');
        this.style.background = '#eef5ff';
        state.selectedIndex = parseInt(this.dataset.index);
        btnView.disabled = false;
        btnDelete.disabled = false;
        checkValidation();
      });
    });
  };

  // 3. 유효성 검사 (암호 6자 이상 + 인증서 선택)
  const checkValidation = () => {
    const isPwOk = passInput.value.length >= 6;
    const isCertOk = state.selectedIndex !== -1;
    submitBtn.disabled = !(isPwOk && isCertOk);
  };

  // 이벤트 바인딩
  storageBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      storageBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      state.selectedStorage = this.dataset.id;
      state.selectedIndex = -1;
      scanCertificates(this.dataset.id);
      checkValidation();
    });
  });

  passInput.addEventListener('input', checkValidation);

  submitBtn.addEventListener('click', () => {
    showToast("서명이 완료되었습니다.");
    setTimeout(() => { location.hash = `#/${META.nextTarget}`; }, 1000);
  });

  cancelBtn.addEventListener('click', () => {
    if(confirm("전자 서명 작성을 취소하시겠습니까?")) {
      history.back();
    }
  });

  // Spec 모달 제어
  const specBtn = document.getElementById('btn-spec');
  const specModal = document.getElementById('modal-spec');
  const specClose = document.getElementById('btn-spec-close');

  specBtn.addEventListener('click', () => specModal.style.display = 'grid');
  specClose.addEventListener('click', () => specModal.style.display = 'none');

  // 초기 로드
  scanCertificates('browser');

})();
</script>
<script src="js/common.js"></script>
<script src="js/session-db.js"></script>
<script src="js/scenario-nav.js"></script>
<script src="js/spec-viewer.js" data-screen-id="0028"></script>
</body>
</html>